<!DOCTYPE html>
<html dir="ltr" lang="en-US">
  <!-- TODO：如果缩放过小，会出现显示错误。加个检测/提醒之类的 -->
  <head>
    <meta http-equiv="content-type" content="text/html; charset=utf-8" />
    <meta name="N.P. Brosowsky" content="Tone.js instrument library loader" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />

    <!-- Styling -->
    <link rel="stylesheet" href="nprogress.css" type="text/css" />
    <!-- Document Title
	============================================= -->
    <title>ToneJS-Instruments Demo</title>
  </head>

  <body>
    <style type="text/css">
      body {
        height: 100vh;
        width: 100vw;
        font-family: Helvetica, arial;
        font-size: 16px;
      }

      #content {
        height: 100%;
        width: 100%;
        display: flex;
        align-items: center;
        justify-content: center;
      }

      .container {
        display: none;
      }

      #Keyboard {
        margin: 3px !important;
      }

      .question_btn {
        margin: 10px 0 10px 0;
        padding: 10px;
        color: rgb(51, 51, 51);
        border: none;
        display: inline-block;
      }

      #note_num_select {
        display: inline-block;
      }
    </style>
    <div id="content">
      <h3 id="loading">Loading...</h3>
      <div class="container">
        <h1>Tone.js-Instruments</h1>
        <p>
          Loads four random instruments from the list. Refresh for different
          instruments.
        </p>
        <div id="Selector"></div>

        <button id="start_btn" class="question_btn">start training</button>
        <button id="replay_btn" class="question_btn">replay</button>
        <button id="play_answer_btn" class="question_btn">play answer</button>
        <div id="note_select_container">
          <span>choose note num: </span>
          <div id="note_num_select"></div>
        </div>
        <br />
        <div id="Keyboard"></div>
      </div>
    </div>
    <script type="text/javascript" src="external-js/nprogress.js"></script>
    <script type="text/javascript" src="external-js/NexusUI.js"></script>
    <script type="text/javascript" src="external-js/Tone.js"></script>
    <script type="text/javascript" src="Tonejs-Instruments.js"></script>

    <script>
      /* const def*/
      const LOW_NOTE = 36;
      const HIGH_NOTE = 72;
      const NOTE_DURATION = 1;
      const MAX_NOTE_NUM = 10;
      const MIN_NOTE_NUM = 2;

      const UP = "↑";
      const DOWN = "↓";
      const EQUAL = "=";

      NProgress.start();
      // load samples / choose 4 random instruments from the list //
      chooseFour = [
        "piano",
        "bass-electric",
        "bassoon",
        "cello",
        "clarinet",
        "contrabass",
        "flute",
        "french-horn",
        "guitar-acoustic",
        "guitar-electric",
        "guitar-nylon",
        "harmonium",
        "harp",
        "organ",
        "saxophone",
        "trombone",
        "trumpet",
        "tuba",
        "violin",
        "xylophone",
      ];
      shuffle(chooseFour);
      chooseFour = chooseFour.slice(0, 4);

      var samples = SampleLibrary.load({
        instruments: chooseFour,
        baseUrl: "samples/",
      });

      var currentInst;
      let currentNoteNum;
      // show keyboard on load //
      Tone.Buffer.on("load", function () {
        document.querySelector(".container").style.display = "block";
        document.querySelector("#loading").style.display = "none";
        NProgress.done();

        // loop through instruments and set release, connect to master output
        for (var property in samples) {
          if (samples.hasOwnProperty(property)) {
            console.log(samples[property]);
            samples[property].release = 0.5;
            samples[property].toMaster();
          }
        }

        currentInst = samples[chooseFour[0]];
        InstSelect.on("change", function (v) {
          currentInst = samples[v.value];
        });

        currentNoteNum = MIN_NOTE_NUM;
        noteNumSelect.on("change", (v) => {
          currentNoteNum = v.value;
        });
      });
      // show error message on loading error //
      Tone.Buffer.on("error", function () {
        document.querySelector("#loading").innerHTML =
          "I'm sorry, there has been an error loading the samples.";
      });

      // create Nexus UI //
      Nexus.colors.accent = "#E0E0E0";

      var InstSelect = new Nexus.Select("#Selector", {
        size: [300, 30],
        options: Object.keys(samples),
      });

      let noteNumSelect = new Nexus.Select("#note_num_select", {
        size: [200, 30],
        options: Array.from(
          { length: MAX_NOTE_NUM - 1 },
          (_, index) => index + MIN_NOTE_NUM
        ),
      });

      // 获取屏幕宽度
      const screenWidth = window.innerWidth;

      // 计算键盘的宽度
      const keyboardWidth = screenWidth * 0.9; // 90% 的屏幕宽度

      // height is 1/5 width
      var keyboardUI = new Nexus.Piano("#Keyboard", {
        size: [keyboardWidth, keyboardWidth * 0.2],
        mode: "button", // 'button', 'toggle', or 'impulse'
        lowNote: LOW_NOTE,
        highNote: HIGH_NOTE,
      });

      keyboardUI.on("change", function (note) {
        console.log(note);
        console.log(Tone.Frequency(note.note, "midi").toNote());
        if (note.state === true) {
          currentInst.triggerAttack(Tone.Frequency(note.note, "midi").toNote());
        } else if (note.state === false) {
          currentInst.triggerRelease(
            Tone.Frequency(note.note, "midi").toNote()
          );
        }
      });

      /* ear training */
      let noteList = [];
      let answerList = [];
      // TODO: change prettier setting format
      // TODO: pick a random current instrument each question
      const replayBtn = document.querySelector("#replay_btn");
      replayBtn.disabled = true;
      replayBtn.addEventListener("click", () => playQuestion(noteList));
      const playAnswerBtn = document.querySelector("#play_answer_btn");
      playAnswerBtn.disabled = true;
      playAnswerBtn.addEventListener("click", () =>
        playQuestion(noteList, true)
      );

      const startBtn = document.querySelector("#start_btn");
      startBtn.addEventListener("click", () => {
        clearLastQuestion();
        console.log("clicked!!!");

        for (let i = 0; i < currentNoteNum; i++) {
          noteList.push(Nexus.ri(LOW_NOTE, HIGH_NOTE));
        }
        console.log(noteList);

        answerList = getAnswerList(noteList);
        console.log(answerList);

        playQuestion(noteList);
        replayBtn.disabled = false;
        playAnswerBtn.disabled = false;
        // TODO: 接收答案、判断答案、播放正确答案
      });

      // helper function //
      function getAnswerList(noteList) {
        let lastNote;
        const answerList = [];
        noteList.forEach((note) => {
          // init
          if (!lastNote) {
            lastNote = note;
            return;
          } else {
            lastNote === note
              ? answerList.push(EQUAL)
              : answerList.push(lastNote > note ? DOWN : UP);
            lastNote = note;
          }
        });
        return answerList;
      }

      function playQuestion(noteList, showNote = false) {
        const now = Tone.now();
        if (showNote) {
          // 按顺序显示每个音符
          // TODO: 太丑了……要换实现方法……
          for (let i = 0; i < noteList.length; i++) {
            setTimeout(() => {
              keyboardUI.toggleKey(noteList[i], true);
              setTimeout(() => {
                keyboardUI.toggleKey(noteList[i], false);
              }, NOTE_DURATION * 1000); // 一段时间后取消显示
            }, i * NOTE_DURATION * 1000); // 每隔 NOTE_DURATION 的时间显示下一个音符
          }
        } else {
          for (let i = 0; i < noteList.length; i++) {
            currentInst.triggerAttackRelease(
              Tone.Frequency(noteList[i], "midi").toNote(),
              NOTE_DURATION,
              now + NOTE_DURATION * i
            );
          }
        }
      }

      function clearLastQuestion() {
        noteList = [];
        answerList = [];
      }

      function shuffle(a) {
        var j, x, i;
        for (i = a.length - 1; i > 0; i--) {
          j = Math.floor(Math.random() * (i + 1));
          x = a[i];
          a[i] = a[j];
          a[j] = x;
        }
      }
    </script>
  </body>
</html>
